'use strict';var MergeLifeGA=function(a){var b=Math.floor;this.pop=[],this.children=[],this.config=a,this.runCount=0,this.topGenome=null,this.evalCount=0,this.lastReport=0,this.lastBestScore=0,this.noImprovement=0,this.totalEvalCount=0,this.startTime=0,this.requestStop=!1,this.runCount=1,this.population=[],this.startTime=new Date().getTime(),this.newTopGenomeCallback=null,this.reportCallback=null,this.foundGenomeCallback=null,this.evalsPerMin=0,this.reportTime=MergeLifeGA.REPORT_TIME,this.randomize=function(a){a.length=0;for(var b=0;b<this.config.config.populationSize;b++)a.push({score:-10,rule:MergeLifeRender.randomRule(),run:this.runCount})},this.report=function(){var a=new Date().getTime(),c=!1;if(this.evalCount++,this.totalEvalCount++,a-this.lastReport>this.reportTime&&(this.lastReport=a,c=!0),null!=this.topGenome&&(this.topGenome.score>this.lastBestScore?(this.lastBestScore=this.topGenome.score,this.noImprovement=0):(this.noImprovement++,this.noImprovement>this.config.config.patience&&!this.requestStop&&(c=!0,this.requestStop=!0))),c){var d=(a-this.startTime)/1e3,e=this.totalEvalCount/d,f=b(60*e);console.log('Run #'+this.runCount+', Eval #'+this.evalCount+': '+JSON.stringify(this.topGenome)+', evals/min='+f),this.evalsPerMin=f,this.reportCallback&&this.reportCallback()}},this.tournament=function(a,c){for(var d=null,e=0;e<c;e++){var f=b(Math.random()*a.length),g=a[f];this.report(),null==d?d=g:d.score<g.score&&(d=g,(null==this.topGenome||d.score>this.topGenome.score)&&(this.topGenome=d,this.newTopGenomeCallback&&this.newTopGenomeCallback(this)))}return d},this.revTournamentIndex=function(a,c){for(var d=null,e=null,f=0;f<c;f++){var g=b(Math.random()*a.length),h=a[g];null==d?(d=h,e=g):d.score>h.score&&(d=h,e=g)}return e},this.mutate=function(a){for(var c='',d=!1;!d;){var e=b(Math.random()*a.length);if('-'!==a.charAt(e)){var f=b(Math.random()*'0123456789abcdef'.length);c=a.substring(0,e)+'0123456789abcdef'.charAt(f)+a.substring(e+1),c=c.toLowerCase(),c.toLowerCase()!==a.toLowerCase()&&(d=!0)}}return c},this.crossover=function(a,c){var d=b(Math.random()*(a.length-MergeLifeGA.CUT_LENGTH)),e=d+MergeLifeGA.CUT_LENGTH;return[a.substring(0,d)+c.substring(d,e)+a.substring(e),c.substring(0,d)+a.substring(d,e)+c.substring(e)]},this.addScoredChild=function(a){if(a.run===this.runCount)if(this.population.length>=this.config.config.populationSize){var b=this.revTournamentIndex(this.population,this.config.config.evalCycles);this.population[b]=a}else this.population.push(a)},this.evolve=function(){if(this.requestStop)this.topGenome.score>=this.config.config.scoreThreshold&&this.foundGenomeCallback&&this.foundGenomeCallback(this.topGenome),this.evalCount=0,this.requestStop=!1,this.noImprovement=0,this.lastReport=0,this.lastBestScore=0,this.children.length=0,this.population.length=0,this.runCount+=1,this.randomize(this.children),this.topGenome=null,this.reportCallback&&this.reportCallback();else if(0===this.children.length)if(Math.random()<this.config.config.crossover){var a=this.tournament(this.population,this.config.config.evalCycles),b=this.tournament(this.population,this.config.config.evalCycles),d=this.crossover(a.rule,b.rule);this.children.push({rule:d[0],score:-10,run:this.runCount}),this.children.push({rule:d[1],score:-10,run:this.runCount})}else{var c=this.tournament(this.population,this.config.config.evalCycles),e=this.mutate(c.rule);this.children.push({rule:e,score:-10,run:this.runCount})}}},MergeLifeObjective=function(a,b){this.track=function(){var a=this.grid.rows,b=this.grid.cols,c=a*b;if(this.currentStats.mode===this.grid.gridMode){var j=this.currentStats.mage+1;this.currentStats.mage=j}else this.currentStats.mode=this.grid.gridMode,this.currentStats.mage=0;for(var d=0,e=0,f=0,g=0;g<this.grid.rows;g++)for(var k=0;k<this.grid.cols;k++){this.grid.mergeGrid[g][k]===this.grid.gridMode?(this.modeCount[g][k]++,this.lastModeStep[g][k]=this.grid.stepCount,50<this.modeCount[g][k]&&d++):this.modeCount[g][k]=0;var l=this.grid.stepCount-this.lastModeStep[g][k];25<this.grid.stepCount&&5<l&&25>l&&f++,this.lastColor[g][k]!==this.grid.mergeGrid[g][k]||this.grid.mergeGrid[g][k]===this.grid.gridMode?(this.lastColor[g][k]=this.grid.mergeGrid[g][k],this.lastColorCount[g][k]=0):(this.lastColorCount[g][k]++,5<this.lastColorCount[g][k]&&e++)}var h=c-(d+e+f),i=maximalRectangle(this.grid.mergeGrid,this.grid.gridMode);return this.currentStats.mc=d,this.currentStats.background=d/c,this.currentStats.foreground=e/c,this.currentStats.active=f/c,this.currentStats.chaos=h/c,this.currentStats.steps=this.grid.stepCount,this.currentStats.rect=i/c,this.currentStats},this.hasStabilized=function(){var a=this.currentStats.mc;if(a!==this.lastModeCount)this.modeCountSame=0,this.lastModeCount=a;else if(this.modeCountSame++,100<this.modeCountSame)return!0;return 1e3<this.grid.stepCount},this.objectiveFunctionCycle=function(a){for(;!this.hasStabilized();){this.grid.singleStep();var b=this.track();a&&console.log(JSON.stringify(b))}return this.scoreCycle()},this.scoreCycle=function(){var a=this;return this.objective.reduce(function(b,c){var d=c.max-c.min;c.stat in a.currentStats||console.log('Unknown objective stat: '+c.stat);var e=a.currentStats[c.stat];if(e<c.min)return b+c.min_weight;if(e>c.max)return b+c.max_weight;var f=(d/2-Math.abs(e-d/2))/(d/2);return f*=c.weight,b+f},0)},this.init=function(){this.lastModeCount=0,this.modeCountSame=0,this.currentStats={},this.currentStats.mage=0,this.currentStats.mode=0,this.currentStats.mc=0,this.currentStats.background=0,this.currentStats.foreground=0,this.currentStats.active=0,this.currentStats.chaos=0},this.objective=b,this.grid=a,this.modeCount=MergeLifeRender.zeros([this.grid.rows,this.grid.cols]),this.lastColor=MergeLifeRender.zeros([this.grid.rows,this.grid.cols]),this.lastColorCount=MergeLifeRender.zeros([this.grid.rows,this.grid.cols]),this.lastModeStep=MergeLifeRender.zeros([this.grid.rows,this.grid.cols]),this.init()};function maxAreaInHist(a){for(var b=[],c=0,d=0;c<a.length;)if(0===b.length||a[b[b.length-1]]<=a[c])b.push(c++);else{var e=b.pop();d=Math.max(d,a[e]*(0===b.length?c:c-b[b.length-1]-1))}return d}function maximalRectangle(a,b){for(var c=a.length,d=0===c?0:a[0].length,e=[],f=0,g=0;g<c;g++){e.push([]),e[g][d]=0;for(var h=0;h<d;h++)e[g][h]=a[g][h]===b?0===g?1:e[g-1][h]+1:0}for(var j,k=0;k<c;k++)j=maxAreaInHist(e[k]),j>f&&(f=j);return f}'undefined'!=typeof module&&'undefined'!=typeof module.exports&&(exports.MergeLifeEvolve=MergeLifeGA,exports.maximalRectangle=maximalRectangle,exports.MergeLifeEvolveUtil=MergeLifeObjective),MergeLifeGA.REPORT_TIME=6e4,MergeLifeObjective.CUT_LENGTH=5;